---
layout: post
title: 工程化
date: 2020-11-08
Author: 念书
keyword: 工程化
excerpt: Grunt
categories: 
tags: [bulid]
comments: true
---

大前端时代到来,压缩合并打包单元测试的自动化简化了工作

SPA  预渲染 

MPA



#### 打包工具

+ Gulp  流式打包构建工具,需要gulpfile.js配置task,小项目 nodejs 清洗代码  不维护了
  
+ Grunt 最早的打包工具生态系统庞大,插件众多,需要安装grunt-cli,需要Gruntfile.js,配置task. 通过watch监听文件完全自动化基于文件I/O

+ fis  前后端都支持(百度内部)

+ Bower  包管理器,松散型的前端管理器(npm的包存在于官网上),可以是文件名,Git地址,文件的链接.bower list 能够提示依赖包是否存在,版本是否正确

+ Yeoman web脚手架  不需要自己配置,内置功能多   Grunt+Bower,有自己的模块

+ Browserify 服务端的库在浏览器中用,require

+ Parcel 零配置.worker,编译缓存,入口是HTML,代码分拆,热更新,代码提示友好  webpack3,4

+ Rollup tree-shaking 打包时把无用的代码删掉 可以配置生成各种格式的js   CMD AMD UMD  webpack2

+ vite

+ Rome

+ Brunch

+ Snowpack

+ neutrino

+ lernajs

+ Webpack  一切皆模块,代码转换,文件优化,代码分隔,模块合并,热更新,校验

  + Entry

  + Output

  + loader   css-loader file-loader url-loader

  + plugins

    + html-webpack-plugins
    + clean-webpack-plugins
  
  + DevServer   devserver+watch 实现更改后自动打包更新页面
  
  + HMR  部分替换  websocket
  
    1. devserver
  
    2. hot: true
  
    3. plugins hotModuleReplacementPlugin
  
    4. js中增加 module.hot.accept
  
       ```js
       if (module.hot) {
         module.hot.accept("./list", () => {
           console.log("element 模块发生热更新了")
         })
           module.hot.decline("./list")
       }
       ```
  
       
  
  + Babel  js编译器   @babel-core  @babel/preset-env @babel-loader    .babelrc
  
    + 原型链上的方法,全局变量babel可能不处理  需要按需引入 @babel-polyfill,  useBuiltIns: "usage",core-js@3   
    + 避免全局污染 @babel/plugin-transform-runtime 以闭包形式注入  @babel-runtime-corejs3  推荐
  
  + 代码质量
  
    + code-metrics-loader
  
  + SourceMap
  
  + TreeShaking  摇树优化  需要ES模块 
  
    + ugligyjsWebpackPlugin  lodash-es  wenpack3  webpack4 production
    + webpack-deep-scope-plugin 加强  scope不进行TreeShaking  现在用不到了
    + css TreeShaking  css module   MiniCssExtractPlugin Purgecss-webpack-plugin 与scoped style冲突  可以使用css-nano进行校验
  
  + 环境区分 webpack-merge
  
    + 开发环境 webpack.prod.js
  
      + devServer sourceMap  接口代理 proxy
  
    + 生产环境 webpack.env.js  默认开启treeShaking和js压缩
  
      + treeShaking
      + 代码压缩
      + 公共代码
  
    + default 公共代码webpack.base.js
  
    + yargs 
  
  + codeApliting
  
  + 打包分析优化 
  
    + base
      + js   代码分割   但是要减少请求
      + 入口配置 entry多入口 ProvidePlugins
      + 抽取共用代码 optimization: {splitchunk:{chunks:"all"} ,runtimechunk}
      + 动态加载 import(```/*webpackchunkname:jquery*/```jquery).then(({default:$})=>{})   @babel/plugin-syntax-dynamic-import
      + css 代码分割 会影响js和css压缩 
      + mini-css-extract-plugin 分隔
      + optimize-css-assets-webpack-plugin  optimization minimizer  css多核压缩 可以使用css-nano
      + terser-webpack-plugin optimization minimizer;   压缩js happypack ts-loader
      + webpack5 废弃上述压缩插件
      + nano
      + cache-loader  哪里慢 在哪里加缓存
      + hard-source-webpack-plugin 全局的缓存
      + cache:true  webpack5
    + 上线阶段
      + ES6不需要编译  module    no-module
      + cdn.polyfill.io/v2/polyfill.min.js?features=Map,Set  
      + thread-loader 多核编译 小项目不要用
      + 多核压缩 UglifyJsPlugin  parallel  核数-1   webpack-parallel-uglify-plugin    小项目不要用
      + 是否更改缓存 webpack-manifest-plugin
      + loading   html-webpack-plugin   webpack插件
      + 请求数量
      + 分析打包结果 CI bundlesize     webpack-chart 分析包大小 需要干净的环境 https://webpack.github.io/analyse/
      + 代码包分析工具 webpack-bundle-analyzer, 可以打出一个json传到上述的分析网站
      + webpack-jarvis webpack2
      + test检测尾缀 exculde排除掉 include 
      + 压缩 webpack-parallel-uglify-plugin 
      + webpack-manifest-plugin   源文件 对应的chunk   hotload
      + htmlWebpackPlugin loading管理
      + bundlesize 分析包大小
      + webpack-chart   webpack --mode development --profile --json > stats.json
    + 开发阶段
      + 花费时间 speed-measure-webpack-plugin
      + 编译情况 webpack-build-notifier 是否编译成功 有提示
      + 打包进度 progress-bar-webpack-plugin
      + 面板优化 webpack-dashboard   webpack5有自己的面板
      + 错误提示 friendly-errors-webpack-plugin 
      + 魔法注释 /*webpackChunkName: "package-name"*/
    
    ```js
      plugins: [
        new MiniCssExtractPlugin({
          filename: "[name].css",
        }),
        new PurgeCSSPlugin({/* glob寻找文件*/
          paths: glob.sync(`${PATHS.src}/**/*`,  { nodir: true }),
        }),
      ]
    ```
    
    



#### webpacck 原理

+ loader

```js
'use strict';
const loaderUtils = require("loader-utils");
const acorn = require("acorn");
const walk = require("acorn-walk");
const MagicString = require('magic-string');
module.exports = function (content) {
    const options = loaderUtils.getOption(this);
    console.log('配置文件',option);
    const ast = acorn.parse(content);
    const code = MagicString(content);
    walk.simple(ast,{
        VariableDeclaration(node){
            console.log("node",node);
            const {start} =  node;
            code.overwrite(start,start+5,"var");
        }
    });
    return code.toString();
}
module.export.pitch = function(r,prerequest,data){
    data.value = "demo";
}
```

+ Plugins

  webpack中把自己的配置项当做插件,在创建compiler之后遍历调用插件的apply方法把自身传入插件.

  而webpack中又使用了tapable,在关键阶段都有事件发布.所以我们只要订阅相应的hooks就可以.

  像我们熟悉的html-webpack-plugin当中就订阅了多个钩子. 

  + compiler.hooks.initialize 拿到一些配置

  + compiler.hooks.thisCompilation  这里为了拿到compilation

  + compilation.hooks.processAssets 这是seal阶段的一个hook

  ```js
  const pluginName = 'ConsoleLogOnBuildWebpackPlugin';
  
  class ConsoleLogOnBuildWebpackPlugin {
    apply(compiler) {//compiler可以访问声明周期
      compiler.hooks.run.tap(pluginName, (compilation) => {
        console.log('The webpack build process is starting!');
      });
    }
  }
  
  module.exports = ConsoleLogOnBuildWebpackPlugin;
  ```


#### webpack源码

关于webpack的源码,webpack源码中采用了tapable(发布订阅模式)和大量的回调函数为参数.所以源码跳跃性很大,阅读有一定的困难.有一个技巧,我们看一个方法可以先看名字,然后再看回调函数中的结果,这用就能做到对函数的功能心中有数. 这里我并没有仔细的看..一些地方我看不太懂. 不知道为什么这样做.

1. webpack 中先检查了是否安装webpack-cil,

2. 进webpack-cli, bootstrop.js new webpackCLI 

3. cli.run() 里边处理了webpack的各种命令 help

4. bulid和watch命令会进先loadWebpack,option,runWebpack方法,

5. runWebpack 方法 compiler = await this.createCompiler(options, callback);

6. ```js
       compiler = this.webpack(//loadwebpack =>require(index.js)=>require(webpack.js)
         config.options,
         callback
           ? (error, stats) => {
               if (error && this.isValidationError(error)) {
                 this.logger.error(error.message);
                 process.exit(2);
               }
    
               callback(error, stats);
             }
           : callback,
       )
   //这个阶段会初始化enhanced-resolve,创建各种Backend并指定不同的provide.并创建一个syncResolver
   ```
   
7. webpack中根据是否是数组创建createMultiCompiler或createCompiler

8. 先初始化options,然后new compiler()  ,会创建一个hook(一个tapable的对应被观察者的map)

9. 遍历plugin把compiler传入plugin中,在这期间会触发一些钩子

10. 在WebpackOptionsApply.js中会根据options中的一些配置引入初始化一些包,并将compiler传进apply方法

11. EntryOptionPlugin中会引入创建EntryOption(DynamicEntryPlugin)实例,并订阅钩子

12. 回到webpack.js 执行compiler.run(),触发run的一些钩子,进入compile方法传入参数onCompile

13. 触发创建compile的一些钩子,并创建Compilation,compilation中进行了一些build,tempalte,chunk的初始化操作.然后触发了compilation的相应钩子(会在dependencyFactories中维护Factory)

14. 在创建Compilation实例的时候会创建几个AsyncQueue,这几个AsyncQueue通过parent字段相关联.并有自己的processor. 

    ```js
    	// 三个状态QUEUED_STATE:0,PROCESSING_STATE:1,DONE_STATE:2		
    /** @type {AsyncQueue<Module, Module, Module>} */
    		this.processDependenciesQueue = new AsyncQueue({
    			name: "processDependencies",
    			parallelism: options.parallelism || 100,
    			processor: this._processModuleDependencies.bind(this)
    		});
    		/** @type {AsyncQueue<Module, string, Module>} */
    		this.addModuleQueue = new AsyncQueue({
    			name: "addModule",
    			parent: this.processDependenciesQueue,
    			getKey: module => module.identifier(),
    			processor: this._addModule.bind(this)
    		});
    		/** @type {AsyncQueue<FactorizeModuleOptions, string, Module | ModuleFactoryResult>} */
    		this.factorizeQueue = new AsyncQueue({
    			name: "factorize",
    			parent: this.addModuleQueue,
    			processor: this._factorizeModule.bind(this)
    		});
    		/** @type {AsyncQueue<Module, Module, Module>} */
    		this.buildQueue = new AsyncQueue({
    			name: "build",
    			parent: this.factorizeQueue,
    			processor: this._buildModule.bind(this)
    		});
    		/** @type {AsyncQueue<Module, Module, Module>} */
    		this.rebuildQueue = new AsyncQueue({
    			name: "rebuild",
    			parallelism: options.parallelism || 100,
    			processor: this._rebuildModule.bind(this)
    		});
    //构造方法中的这句话使得addModuleQueue,factorizeQueue,buildQueue的_root都是processDependenciesQueue
    this._root = parent ? parent._root : this;
    ```

    

15. 触发了make的钩子,开始打包

16. 调用了compilation.addEntry,_addEntryItem,this.addModuleTree,handleModuleCreation,factorizeModule

17. this.factorizeQueue.add(options, callback);  维护了 this._entries和this._queued  这步细节可以跳过,先看18

    1. ensureProcessing   方法 需要注意的是这里的root是processDependenciesQueue,所以this也会改变,通过遍历child会又会调用factorizeQueue的_startProcessing这里this又变回了
    2. _startProcessing中只做了一件事触发了beforeStart钩子,并在回调中调用了processor也就是_factorizeModule
    3. factorizeModule中解构并调用了factory.create.我们看一下回调方法,发现这个方法返回的是三个依赖fileDependencies,contextDependencies,missingDependencies,并且有module字段,可以知道这个方法是构造依赖关系,并创建module.
    4. NormalModuleFatory中的create方法,一开始就是初始化一些变量组成resolveData
    5. 触发beforeResolve在回调中触发factorize传入resolveData
    6. 先进入一个回调,handleExternals处理外部的文件,这里就是./src没匹配上,然后就调用callback到另一个NormalModuleFatory中的回调  这里对路径和content进行匹配..都没匹配上就进入 defaultResolve
    7. ResolveFactory 创建一个resolver,然后调用resolver.resolve doResolve 触发resolve的钩子,进入ResolverCachePlugin 这里先找缓存没有或错误就进入 doRealResolve,有从snapshot则取出直接回调
    8. doRealResolve创建newRequest,newResolveContext然后传给doResolve,可以看一下回调,回调中拿到三个Dependencies创建了Snapshot
    9. 在这之后就开始enhanced-resolve去找入口文件.通过tapable和一些用source和target关联起来的Plugin来生成文件路径并判断路径是否存在然后把路径加入不同的Dependencies.在判断完开始的几个路径后,会先根据一个rawFile,AppendPlugin添加不同的后缀得到file,AliasFieldPlugin判断是否有别名进入finalFile,最后判断文件是否存在.
    10. 这样找到入口文件index.js后会用SymlinkPlugin做符号链接.并把路径添加到fileDependencies.
    11. 这样创建完成后便开始进入回调,首先是doRealReaolve的回调创建snapshot,
    12. fileTimestampQueue.add 通过fs.stat读取信息,这是一个异步的过程,通过jobs变量控制        itemCache.store加入缓存.然后callback
    13. needCalls的回调收集loader.然后就不断callback


    ```js
    /*IDLE: 空闲
    	insert data: goto SYNC
    
    SYNC:	同步
    	before provide: run ticks
    	event loop tick: goto ASYNC_ACTIVE
    
    ASYNC:  异步
    	timeout: run tick, goto ASYNC_PASSIVE
    
    ASYNC_PASSIVE:
    	before provide: run ticks
    
    IDLE --[insert data]--> SYNC --[event loop tick]--> ASYNC_ACTIVE --[interval tick]-> ASYNC_PASSIVE
                                                              ^                             |
                                                              +---------[insert data]-------+*/
    ```

18. 我们可以跳过16,看factorizeModule的回调函数,会接受一个factoryResult,这个factoryResult里边有一个module,然后调用addModule, _addModule.this.modules.add(module);
18. ModuleGraph.setModuleGraphForModule(module, this.moduleGraph);
18. _handleModuleBuildAndDependencies => this.buildModule => _buildModule =>module.needBuild=>module.build=>this._doBuild
18. runLoaders    runloader的过程是先index++ 去import(require)loader模块,并执行pitch方法. 一但pitch方法有返回值便执行loader然后index--.如果没有便一直到最后一个loader然后从最后一个loader开始执行(拿到文件buffer).
18. 拿到loader后的资源返回,然后执行JavascriptParser.js的this.parser.parse(souce),转换成AST并且处理
18. 这会拿到依赖,然后继续上面的过程.
18. 不断重复上面的过程,收集全部的module后返回到Compilation的make中
18. 开始seal,seal就是创建chunk的过程. 
18. 首先创建chunkGraph并关联module,   optimizeDependencies (SideEffectsFlagPlugin)
18. 然后遍历entries,addchunk,创建Entrypoint  connectChunkGroupAndChunk
18. buildChunkGraph  visitModules  connectChunkGroups
18. 然后就是大量的钩子 this.hooks.optimizeChunks(EnsureChunkConditionsPlugin,RemoveEmptyChunksPlugin,MergeDuplicateChunksPlugin,SplitChunksPlugin)
18. this.codeGeneration  这里会遍历module然后拿到template,对代码进行一系列的替换,比如把import替换成`__webpack_rquire__`;JavascriptModulesPlugin 中的renderBootstrap
18. onCompiled
18. emitAssets 
18. 最后生成了一个`__webpack_modules__`的模块字典.

```js
compile(callback) { 
		const params = this.newCompilationParams();
    	//编译之前
		this.hooks.beforeCompile.callAsync(params, err => {
			if (err) return callback(err);
			//编译
			this.hooks.compile.call(params);

			const compilation = this.newCompilation(params);

			const logger = compilation.getLogger("webpack.Compiler");

			logger.time("make hook");
            //开始制作 触发make的tap调用 addEntry
			this.hooks.make.callAsync(compilation, err => {
				logger.timeEnd("make hook");
				if (err) return callback(err);

				logger.time("finish make hook");
                 //结束制作
				this.hooks.finishMake.callAsync(compilation, err => {
					logger.timeEnd("finish make hook");
					if (err) return callback(err);

					process.nextTick(() => {
						logger.time("finish compilation");
						compilation.finish(err => {
							logger.timeEnd("finish compilation");
							if (err) return callback(err);

							logger.time("seal compilation");
                            //写入内存
							compilation.seal(err => {
								logger.timeEnd("seal compilation");
								if (err) return callback(err);

								logger.time("afterCompile hook");
                                //编译之后
								this.hooks.afterCompile.callAsync(compilation, err => {
									logger.timeEnd("afterCompile hook");
									if (err) return callback(err);

									return callback(null, compilation);
								});
							});
						});
					});
				});
			});
		});
	}
```

```js
handleModuleCreation(
		{
			factory,
			dependencies,
			originModule,
			contextInfo,
			context,
			recursive = true,
			connectOrigin = recursive
		},
		callback
	) {
		const moduleGraph = this.moduleGraph;

		const currentProfile = this.profile ? new ModuleProfile() : undefined;

		this.factorizeModule(
			{
				currentProfile,
				factory,
				dependencies,
				factoryResult: true,
				originModule,
				contextInfo,
				context
			},
			(err, factoryResult) => {
				const applyFactoryResultDependencies = () => {
					const { fileDependencies, contextDependencies, missingDependencies } =
						factoryResult;
					if (fileDependencies) {
						this.fileDependencies.addAll(fileDependencies);
					}
					if (contextDependencies) {
						this.contextDependencies.addAll(contextDependencies);
					}
					if (missingDependencies) {
						this.missingDependencies.addAll(missingDependencies);
					}
				};
				if (err) {
					if (factoryResult) applyFactoryResultDependencies();
					if (dependencies.every(d => d.optional)) {
						this.warnings.push(err);
						return callback();
					} else {
						this.errors.push(err);
						return callback(err);
					}
				}

				const newModule = factoryResult.module; //产生模块

				if (!newModule) {
					applyFactoryResultDependencies();
					return callback();
				}

				if (currentProfile !== undefined) {
					moduleGraph.setProfile(newModule, currentProfile);
				}

				this.addModule(newModule, (err, module) => {
					if (err) {
						applyFactoryResultDependencies();
						if (!err.module) {
							err.module = module;
						}
						this.errors.push(err);

						return callback(err);
					}

					if (
						this._unsafeCache &&
						factoryResult.cacheable !== false &&
						/** @type {any} */ (module).restoreFromUnsafeCache &&
						this._unsafeCachePredicate(module)
					) {
						const unsafeCacheableModule =
							/** @type {Module & { restoreFromUnsafeCache: Function }} */ (
								module
							);
						for (let i = 0; i < dependencies.length; i++) {
							const dependency = dependencies[i];
							moduleGraph.setResolvedModule(
								connectOrigin ? originModule : null,
								dependency,
								unsafeCacheableModule
							);
							unsafeCacheDependencies.set(dependency, unsafeCacheableModule);
						}
						if (!unsafeCacheData.has(unsafeCacheableModule)) {
							unsafeCacheData.set(
								unsafeCacheableModule,
								unsafeCacheableModule.getUnsafeCacheData()
							);
						}
					} else {
						applyFactoryResultDependencies();
						for (let i = 0; i < dependencies.length; i++) {
							const dependency = dependencies[i];
							moduleGraph.setResolvedModule(
								connectOrigin ? originModule : null,
								dependency,
								module
							);
						}
					}

					moduleGraph.setIssuerIfUnset(
						module,
						originModule !== undefined ? originModule : null
					);
					if (module !== newModule) {
						if (currentProfile !== undefined) {
							const otherProfile = moduleGraph.getProfile(module);
							if (otherProfile !== undefined) {
								currentProfile.mergeInto(otherProfile);
							} else {
								moduleGraph.setProfile(module, currentProfile);
							}
						}
					}

					this._handleModuleBuildAndDependencies(
						originModule,
						module,
						recursive,
						callback
					);
				});
			}
		);
	}
```



```js
const finalCallback = (err, stats) => {
			if (logger) logger.time("beginIdle");
			this.idle = true;
			this.cache.beginIdle();
			this.idle = true;
			if (logger) logger.timeEnd("beginIdle");
			this.running = false;
			if (err) {
				this.hooks.failed.call(err);
			}
			if (callback !== undefined) callback(err, stats);
			this.hooks.afterDone.call(stats);
		};

		const startTime = Date.now();

		this.running = true;

		const onCompiled = (err, compilation) => {
			if (err) return finalCallback(err);

			if (this.hooks.shouldEmit.call(compilation) === false) {
				compilation.startTime = startTime;
				compilation.endTime = Date.now();
				const stats = new Stats(compilation);
				this.hooks.done.callAsync(stats, err => {
					if (err) return finalCallback(err);
					return finalCallback(null, stats);
				});
				return;
			}

			process.nextTick(() => {
				logger = compilation.getLogger("webpack.Compiler");
				logger.time("emitAssets");
				this.emitAssets(compilation, err => {
					logger.timeEnd("emitAssets");
					if (err) return finalCallback(err);

					if (compilation.hooks.needAdditionalPass.call()) {
						compilation.needAdditionalPass = true;

						compilation.startTime = startTime;
						compilation.endTime = Date.now();
						logger.time("done hook");
						const stats = new Stats(compilation);
						this.hooks.done.callAsync(stats, err => {
							logger.timeEnd("done hook");
							if (err) return finalCallback(err);

							this.hooks.additionalPass.callAsync(err => {
								if (err) return finalCallback(err);
								this.compile(onCompiled);
							});
						});
						return;
					}

					logger.time("emitRecords");
					this.emitRecords(err => {
						logger.timeEnd("emitRecords");
						if (err) return finalCallback(err);

						compilation.startTime = startTime;
						compilation.endTime = Date.now();
						logger.time("done hook");
						const stats = new Stats(compilation);
						this.hooks.done.callAsync(stats, err => {
							logger.timeEnd("done hook");
							if (err) return finalCallback(err);
							this.cache.storeBuildDependencies(
								compilation.buildDependencies,
								err => {
									if (err) return finalCallback(err);
									return finalCallback(null, stats);
								}
							);
						});
					});
				});
			});
		};
```



需要的包

+ babylon   js=>AST
+ babel-traverse   遍历 AST require      (正则 注释和回溯)
+ babel-core 



中途岛 node中间层

node BFF,  node代理java,修改API SSR

lint   code=>AST遍历



CDN  cdn集群      CI   CD  





#### webpack5

+ top-level-await  await可以不在async中

+ cache: true 代替缓存的cache插件

+ loader

  

```
node --inspect --inspect-brk node_modules/webpack/bin/webpack --config ./build/webpack.base.config.js
```



```
NormalModule {
  dependencies: [
    CssDependency {
      module: [CssModule],
      weak: false,
      optional: false,
      loc: undefined,
      identifier: 'D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css',
      identifierIndex: 0,
      content: 'body {\r\n  background: green;\r\n  height: 100vh;\r\n}\r\n',
      media: '',
      sourceMap: undefined,
      context: 'D:\\workspace\\webpack4\\src\\assets'
    }
  ],
  blocks: [],
  variables: [],
  type: 'javascript/auto',
  context: 'D:\\workspace\\webpack4\\src\\assets',
  debugId: 1023,
  hash: undefined,
  renderedHash: undefined,
  resolveOptions: {},
  factoryMeta: {},
  warnings: [],
  errors: [],
  buildMeta: { providedExports: true },
  buildInfo: {
    cacheable: true,
    fileDependencies: Set(3) {
      'D:\\workspace\\webpack4\\src\\assets\\base2.css',
      'D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\runtime\\api.js',
      'D:\\workspace\\webpack4\\postcss.config.js'
    },
    contextDependencies: Set(0) {},
    assets: undefined,
    assetsInfo: undefined,
    temporaryProvidedExports: false
  },
  reasons: [
    ModuleReason {
      module: [NormalModule],
      dependency: [HarmonyImportSideEffectDependency],
      explanation: undefined,
      _chunks: null
    },
    ModuleReason {
      module: [NormalModule],
      dependency: [HarmonyImportSideEffectDependency],
      explanation: undefined,
      _chunks: null
    }
  ],
  _chunks: SortableSet(2) [Set] {
    Chunk {
      id: null,
      ids: null,
      debugId: 1014,
      name: 'c-c1',
      preventIntegration: false,
      entryModule: [NormalModule],
      _modules: [SortableSet [Set]],
      filenameTemplate: undefined,
      _groups: [SortableSet [Set]],
      files: [],
      rendered: false,
      hash: undefined,
      contentHash: [Object: null prototype] {},
      renderedHash: undefined,
      chunkReason: undefined,
      extraAsync: false,
      removedModules: undefined
    },
    Chunk {
      id: null,
      ids: null,
      debugId: 1015,
      name: 'c-c2',
      preventIntegration: false,
      entryModule: [NormalModule],
      _modules: [SortableSet [Set]],
      filenameTemplate: undefined,
      _groups: [SortableSet [Set]],
      files: [],
      rendered: false,
      hash: undefined,
      contentHash: [Object: null prototype] {},
      renderedHash: undefined,
      chunkReason: undefined,
      extraAsync: false,
      removedModules: undefined
    },
    _sortFn: [Function: sortById],
    _lastActiveSortFn: null,
    _cache: undefined,
    _cacheOrderIndependent: undefined
  },
  id: null,
  index: 12,
  index2: 12,
  depth: 1,
  issuer: NormalModule {
    dependencies: [
      [HarmonyCompatibilityDependency],
      [HarmonyInitDependency],
      [ConstDependency],
      [HarmonyImportSideEffectDependency],
      [ConstDependency],
      [HarmonyImportSideEffectDependency]
    ],
    blocks: [],
    variables: [],
    type: 'javascript/auto',
    context: 'D:\\workspace\\webpack4\\src\\views\\c\\c2',
    debugId: 1011,
    hash: undefined,
    renderedHash: undefined,
    resolveOptions: {},
    factoryMeta: {},
    warnings: [],
    errors: [],
    buildMeta: { exportsType: 'namespace', providedExports: [] },
    buildInfo: {
      cacheable: true,
      fileDependencies: [Set],
      contextDependencies: Set(0) {},
      assets: undefined,
      assetsInfo: undefined,
      strict: true,
      exportsArgument: '__webpack_exports__',
      temporaryProvidedExports: false
    },
    reasons: [ [ModuleReason] ],
    _chunks: SortableSet(1) [Set] {
      [Chunk],
      _sortFn: [Function: sortById],
      _lastActiveSortFn: null,
      _cache: undefined,
      _cacheOrderIndependent: undefined
    },
    id: null,
    index: 14,
    index2: 14,
    depth: 0,
    issuer: null,
    profile: undefined,
    prefetched: false,
    built: true,
    used: true,
    usedExports: true,
    optimizationBailout: [],
    _rewriteChunkInReasons: undefined,
    useSourceMap: true,
    _source: SourceMapSource {
      _value: 'import "@/assets/base2.css";\n' +
        'import "@/assets/reset.css";\n' +
        'console.log("只是c2");',
      _name: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js!D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
      _sourceMap: [Object],
      _originalSource: undefined,
      _innerSourceMap: undefined,
      _removeOriginalSource: undefined
    },
    request: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js!D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
    userRequest: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
    rawRequest: 'D:/workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
    binary: false,
    parser: Parser {
      _pluginCompat: [SyncBailHook],
      hooks: [Object],
      options: {},
      sourceType: 'auto',
      scope: undefined,
      state: undefined,
      comments: undefined
    },
    generator: JavascriptGenerator {},
    resource: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
    matchResource: undefined,
    loaders: [ [Object] ],
    error: null,
    _sourceSize: null,
    _buildHash: '24d5cfbaa6a3443422f9d40214e2ba1f',
    buildTimestamp: 1655050760280,
    _cachedSources: Map(0) {},
    lineToLine: false,
    _lastSuccessfulBuildMeta: { exportsType: 'namespace', providedExports: [] },
    _ast: null
  },
  profile: undefined,
  prefetched: false,
  built: true,
  used: true,
  usedExports: false,
  optimizationBailout: [],
  _rewriteChunkInReasons: undefined,
  useSourceMap: true,
  _source: OriginalSource {
    _value: '// extracted by mini-css-extract-plugin',
    _name: 'D:\\workspace\\webpack4\\node_modules\\mini-css-extract-plugin\\dist\\loader.js!D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css'
  },
  request: 'D:\\workspace\\webpack4\\node_modules\\mini-css-extract-plugin\\dist\\loader.js!D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css',
  userRequest: 'D:\\workspace\\webpack4\\src\\assets\\base2.css',
  rawRequest: '@/assets/base2.css',
  binary: false,
  parser: Parser {
    _pluginCompat: SyncBailHook {
      _args: [Array],
      taps: [Array],
      interceptors: [],
      call: [Function: lazyCompileHook],
      promise: [Function: lazyCompileHook],
      callAsync: [Function: lazyCompileHook],
      _x: undefined
    },
    hooks: {
      evaluateTypeof: [HookMap],
      evaluate: [HookMap],
      evaluateIdentifier: [HookMap],
      evaluateDefinedIdentifier: [HookMap],
      evaluateCallExpressionMember: [HookMap],
      statement: [SyncBailHook],
      statementIf: [SyncBailHook],
      label: [HookMap],
      import: [SyncBailHook],
      importSpecifier: [SyncBailHook],
      export: [SyncBailHook],
      exportImport: [SyncBailHook],
      exportDeclaration: [SyncBailHook],
      exportExpression: [SyncBailHook],
      exportSpecifier: [SyncBailHook],
      exportImportSpecifier: [SyncBailHook],
      varDeclaration: [HookMap],
      varDeclarationLet: [HookMap],
      varDeclarationConst: [HookMap],
      varDeclarationVar: [HookMap],
      canRename: [HookMap],
      rename: [HookMap],
      assigned: [HookMap],
      assign: [HookMap],
      typeof: [HookMap],
      importCall: [SyncBailHook],
      call: [HookMap],
      callAnyMember: [HookMap],
      new: [HookMap],
      expression: [HookMap],
      expressionAnyMember: [HookMap],
      expressionConditionalOperator: [SyncBailHook],
      expressionLogicalOperator: [SyncBailHook],
      program: [SyncBailHook],
      hotAcceptCallback: [SyncBailHook],
      hotAcceptWithoutCallback: [SyncBailHook]
    },
    options: {},
    sourceType: 'auto',
    scope: undefined,
    state: undefined,
    comments: undefined
  },
  generator: JavascriptGenerator {},
  resource: 'D:\\workspace\\webpack4\\src\\assets\\base2.css',
  matchResource: undefined,
  loaders: [
    {
      options: undefined,
      loader: 'D:\\workspace\\webpack4\\node_modules\\mini-css-extract-plugin\\dist\\loader.js'      
    },
    {
      options: [Object],
      ident: 'ref--5-1',
      loader: 'D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js'
    },
    {
      loader: 'D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js',
      options: undefined
    }
  ],
  error: null,
  _sourceSize: null,
  _buildHash: '5a855d6f954c109e28c85c504bd0c1d3',
  buildTimestamp: 1655050760465,
  _cachedSources: Map(0) {},
  lineToLine: false,
  _lastSuccessfulBuildMeta: { providedExports: true },
  _ast: null
} ๑¯㉨¯๑
CssModule {
  dependencies: [],
  blocks: [],
  variables: [],
  type: 'css/mini-extract',
  context: 'D:\\workspace\\webpack4\\src\\assets',
  debugId: 1036,
  hash: undefined,
  renderedHash: undefined,
  resolveOptions: {},
  factoryMeta: {},
  warnings: [],
  errors: [],
  buildMeta: { providedExports: true },
  buildInfo: { temporaryProvidedExports: false },
  reasons: [
    ModuleReason {
      module: [NormalModule],
      dependency: [CssDependency],
      explanation: undefined,
      _chunks: null
    }
  ],
  _chunks: SortableSet(2) [Set] {
    Chunk {
      id: null,
      ids: null,
      debugId: 1014,
      name: 'c-c1',
      preventIntegration: false,
      entryModule: [NormalModule],
      _modules: [SortableSet [Set]],
      filenameTemplate: undefined,
      _groups: [SortableSet [Set]],
      files: [],
      rendered: false,
      hash: undefined,
      contentHash: [Object: null prototype] {},
      renderedHash: undefined,
      chunkReason: undefined,
      extraAsync: false,
      removedModules: undefined
    },
    Chunk {
      id: null,
      ids: null,
      debugId: 1015,
      name: 'c-c2',
      preventIntegration: false,
      entryModule: [NormalModule],
      _modules: [SortableSet [Set]],
      filenameTemplate: undefined,
      _groups: [SortableSet [Set]],
      files: [],
      rendered: false,
      hash: undefined,
      contentHash: [Object: null prototype] {},
      renderedHash: undefined,
      chunkReason: undefined,
      extraAsync: false,
      removedModules: undefined
    },
    _sortFn: [Function: sortById],
    _lastActiveSortFn: null,
    _cache: undefined,
    _cacheOrderIndependent: undefined
  },
  id: '',
  index: 13,
  index2: 11,
  depth: 2,
  issuer: NormalModule {
    dependencies: [ [CssDependency] ],
    blocks: [],
    variables: [],
    type: 'javascript/auto',
    context: 'D:\\workspace\\webpack4\\src\\assets',
    debugId: 1023,
    hash: undefined,
    renderedHash: undefined,
    resolveOptions: {},
    factoryMeta: {},
    warnings: [],
    errors: [],
    buildMeta: { providedExports: true },
    buildInfo: {
      cacheable: true,
      fileDependencies: [Set],
      contextDependencies: Set(0) {},
      assets: undefined,
      assetsInfo: undefined,
      temporaryProvidedExports: false
    },
    reasons: [ [ModuleReason], [ModuleReason] ],
    _chunks: SortableSet(2) [Set] {
      [Chunk],
      [Chunk],
      _sortFn: [Function: sortById],
      _lastActiveSortFn: null,
      _cache: undefined,
      _cacheOrderIndependent: undefined
    },
    id: null,
    index: 12,
    index2: 12,
    depth: 1,
    issuer: NormalModule {
      dependencies: [Array],
      blocks: [],
      variables: [],
      type: 'javascript/auto',
      context: 'D:\\workspace\\webpack4\\src\\views\\c\\c2',
      debugId: 1011,
      hash: undefined,
      renderedHash: undefined,
      resolveOptions: {},
      factoryMeta: {},
      warnings: [],
      errors: [],
      buildMeta: [Object],
      buildInfo: [Object],
      reasons: [Array],
      _chunks: [SortableSet [Set]],
      id: null,
      index: 14,
      index2: 14,
      depth: 0,
      issuer: null,
      profile: undefined,
      prefetched: false,
      built: true,
      used: true,
      usedExports: true,
      optimizationBailout: [],
      _rewriteChunkInReasons: undefined,
      useSourceMap: true,
      _source: [SourceMapSource],
      request: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js!D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
      userRequest: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
      rawRequest: 'D:/workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
      binary: false,
      parser: [Parser],
      generator: JavascriptGenerator {},
      resource: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
      matchResource: undefined,
      loaders: [Array],
      error: null,
      _sourceSize: null,
      _buildHash: '24d5cfbaa6a3443422f9d40214e2ba1f',
      buildTimestamp: 1655050760280,
      _cachedSources: Map(0) {},
      lineToLine: false,
      _lastSuccessfulBuildMeta: [Object],
      _ast: null
    },
    profile: undefined,
    prefetched: false,
    built: true,
    used: true,
    usedExports: false,
    optimizationBailout: [],
    _rewriteChunkInReasons: undefined,
    useSourceMap: true,
    _source: OriginalSource {
      _value: '// extracted by mini-css-extract-plugin',
      _name: 'D:\\workspace\\webpack4\\node_modules\\mini-css-extract-plugin\\dist\\loader.js!D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css'
    },
    request: 'D:\\workspace\\webpack4\\node_modules\\mini-css-extract-plugin\\dist\\loader.js!D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css',
    userRequest: 'D:\\workspace\\webpack4\\src\\assets\\base2.css',
    rawRequest: '@/assets/base2.css',
    binary: false,
    parser: Parser {
      _pluginCompat: [SyncBailHook],
      hooks: [Object],
      options: {},
      sourceType: 'auto',
      scope: undefined,
      state: undefined,
      comments: undefined
    },
    generator: JavascriptGenerator {},
    resource: 'D:\\workspace\\webpack4\\src\\assets\\base2.css',
    matchResource: undefined,
    loaders: [ [Object], [Object], [Object] ],
    error: null,
    _sourceSize: null,
    _buildHash: '5a855d6f954c109e28c85c504bd0c1d3',
    buildTimestamp: 1655050760465,
    _cachedSources: Map(0) {},
    lineToLine: false,
    _lastSuccessfulBuildMeta: { providedExports: true },
    _ast: null
  },
  profile: undefined,
  prefetched: false,
  built: false,
  used: true,
  usedExports: true,
  optimizationBailout: [],
  _rewriteChunkInReasons: undefined,
  useSourceMap: true,
  _source: null,
  _identifier: 'D:\\workspace\\webpack4\\node_modules\\css-loader\\dist\\cjs.js??ref--5-1!D:\\workspace\\webpack4\\node_modules\\postcss-loader\\src\\index.js!D:\\workspace\\webpack4\\src\\assets\\base2.css',
  _identifierIndex: 0,
  content: 'body {\r\n  background: green;\r\n  height: 100vh;\r\n}\r\n',
  media: '',
  sourceMap: undefined
} ๑¯㉨¯๑
<ref *1> NormalModule {
  dependencies: [
    HarmonyCompatibilityDependency {
      module: null,
      weak: false,
      optional: false,
      loc: [Object],
      originModule: [Circular *1]
    },
    HarmonyInitDependency {
      module: null,
      weak: false,
      optional: false,
      loc: [Object],
      originModule: [Circular *1]
    },
    ConstDependency {
      module: null,
      weak: false,
      optional: false,
      loc: [SourceLocation],
      expression: '',
      range: [Array],
      requireWebpackRequire: undefined
    },
    HarmonyImportSideEffectDependency {
      module: [NormalModule],
      weak: false,
      optional: false,
      loc: [SourceLocation],
      request: '@/assets/base2.css',
      userRequest: '@/assets/base2.css',
      redirectedModule: undefined,
      originModule: [Circular *1],
      sourceOrder: 1,
      parserScope: {}
    },
    ConstDependency {
      module: null,
      weak: false,
      optional: false,
      loc: [SourceLocation],
      expression: '',
      range: [Array],
      requireWebpackRequire: undefined
    },
    HarmonyImportSideEffectDependency {
      module: [NormalModule],
      weak: false,
      optional: false,
      loc: [SourceLocation],
      request: '@/assets/reset.css',
      userRequest: '@/assets/reset.css',
      redirectedModule: undefined,
      originModule: [Circular *1],
      sourceOrder: 2,
      parserScope: {}
    }
  ],
  blocks: [],
  variables: [],
  type: 'javascript/auto',
  context: 'D:\\workspace\\webpack4\\src\\views\\c\\c2',
  debugId: 1011,
  hash: undefined,
  renderedHash: undefined,
  resolveOptions: {},
  factoryMeta: {},
  warnings: [],
  errors: [],
  buildMeta: { exportsType: 'namespace', providedExports: [] },
  buildInfo: {
    cacheable: true,
    fileDependencies: Set(1) { 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js' },
    contextDependencies: Set(0) {},
    assets: undefined,
    assetsInfo: undefined,
    strict: true,
    exportsArgument: '__webpack_exports__',
    temporaryProvidedExports: false
  },
  reasons: [
    ModuleReason {
      module: null,
      dependency: [SingleEntryDependency],
      explanation: undefined,
      _chunks: null
    }
  ],
  _chunks: SortableSet(1) [Set] {
    Chunk {
      id: null,
      ids: null,
      debugId: 1015,
      name: 'c-c2',
      preventIntegration: false,
      entryModule: [Circular *1],
      _modules: [SortableSet [Set]],
      filenameTemplate: undefined,
      _groups: [SortableSet [Set]],
      files: [],
      rendered: false,
      hash: undefined,
      contentHash: [Object: null prototype] {},
      renderedHash: undefined,
      chunkReason: undefined,
      extraAsync: false,
      removedModules: undefined
    },
    _sortFn: [Function: sortById],
    _lastActiveSortFn: null,
    _cache: undefined,
    _cacheOrderIndependent: undefined
  },
  id: null,
  index: 14,
  index2: 14,
  depth: 0,
  issuer: null,
  profile: undefined,
  prefetched: false,
  built: true,
  used: true,
  usedExports: true,
  optimizationBailout: [],
  _rewriteChunkInReasons: undefined,
  useSourceMap: true,
  _source: SourceMapSource {
    _value: 'import "@/assets/base2.css";\n' +
      'import "@/assets/reset.css";\n' +
      'console.log("只是c2");',
    _name: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js!D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
    _sourceMap: {
      version: 3,
      file: undefined,
      names: [Array],
      sourceRoot: undefined,
      sources: [Array],
      sourcesContent: [Array],
      mappings: 'AAAA,OAAO,oBAAP;AACA,OAAO,oBAAP;AACAA,OAAO,CAACC,GAAR,CAAY,MAAZ'
    },
    _originalSource: undefined,
    _innerSourceMap: undefined,
    _removeOriginalSource: undefined
  },
  request: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js!D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
  userRequest: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
  rawRequest: 'D:/workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
  binary: false,
  parser: Parser {
    _pluginCompat: SyncBailHook {
      _args: [Array],
      taps: [Array],
      interceptors: [],
      call: [Function: lazyCompileHook],
      promise: [Function: lazyCompileHook],
      callAsync: [Function: lazyCompileHook],
      _x: undefined
    },
    hooks: {
      evaluateTypeof: [HookMap],
      evaluate: [HookMap],
      evaluateIdentifier: [HookMap],
      evaluateDefinedIdentifier: [HookMap],
      evaluateCallExpressionMember: [HookMap],
      statement: [SyncBailHook],
      statementIf: [SyncBailHook],
      label: [HookMap],
      import: [SyncBailHook],
      importSpecifier: [SyncBailHook],
      export: [SyncBailHook],
      exportImport: [SyncBailHook],
      exportDeclaration: [SyncBailHook],
      exportExpression: [SyncBailHook],
      exportSpecifier: [SyncBailHook],
      exportImportSpecifier: [SyncBailHook],
      varDeclaration: [HookMap],
      varDeclarationLet: [HookMap],
      varDeclarationConst: [HookMap],
      varDeclarationVar: [HookMap],
      canRename: [HookMap],
      rename: [HookMap],
      assigned: [HookMap],
      assign: [HookMap],
      typeof: [HookMap],
      importCall: [SyncBailHook],
      call: [HookMap],
      callAnyMember: [HookMap],
      new: [HookMap],
      expression: [HookMap],
      expressionAnyMember: [HookMap],
      expressionConditionalOperator: [SyncBailHook],
      expressionLogicalOperator: [SyncBailHook],
      program: [SyncBailHook],
      hotAcceptCallback: [SyncBailHook],
      hotAcceptWithoutCallback: [SyncBailHook]
    },
    options: {},
    sourceType: 'auto',
    scope: undefined,
    state: undefined,
    comments: undefined
  },
  generator: JavascriptGenerator {},
  resource: 'D:\\workspace\\webpack4\\src\\views\\c\\c2\\entry.js',
  matchResource: undefined,
  loaders: [
    {
      options: undefined,
      loader: 'D:\\workspace\\webpack4\\node_modules\\babel-loader\\lib\\index.js'
    }
  ],
```







一次优化记录

公司有一个自己的代码文档管理的项目,用的是云服务,网速慢,进登录页要20s+,抽时间优化一下,刚好缺少实战机会

访问了一下网址发现请求很多,最耗时间的一个请求是一个2m的js,下载了19s.  很明显优化的方向就是减少这个js的体积



下载下代码来,看一下webpack的配置,splitChunks下直接是缓存组,也就是默认的chunks是"async",两个缓存组一个打包第三方库,另一个提取公共文件

除了异步组件引入的. 妥妥的官网的标准配置,好像没有什么问题.  但是我们这里第三方的包太多了,即使是压缩后也有2M,一个一个的拆包又特别麻烦.那我们就给第三方库拆一下包,设置一下maxSize,这样超过这个大小就不合并为1个包,这又导致了一个问题,包太多.发出的请求也多.

限制chunk数量的有两种方法,一种是

+ webpack.optimize.LimitChunkCountPlugin 的 maxChunks来设置最多的包数量,但是这个数量不好掌握,如果异步的和同步的合成一个,那么首页就又变慢了
+ webpack.optimize.MinChunkSizePlugin的minChunkSize来设置包的最小体积,这个可以减少包的数量,影响的又是体积小的包

这样打完发布后,请求时间在5s左右吧. 受网速限制,而且项目初始化引的包太多了.  当然还有一定的优化空间,比如采用cdn, 减少入口文件引用的库

在查看发布后的页面中发现了有部分js是在onload的事件完成后请求,采用了prefetch,preload的plugins来与读取异步组件依赖的js,css

```json
    splitChunks: {
      cacheGroups: {
        vendors: {
          name: 'chunk-vendors',
          test: /[\\/]node_modules[\\/]/,
          priority: -10,
          chunks: 'initial'
        },
        common: {
          name: 'chunk-common',
          minChunks: 2,
          priority: -20,
          chunks: 'initial',
          reuseExistingChunk: true
        }
      }
    }
```

```
          libs: {
            // 第三方库
            name: 'chunk-libs',
            test: /[\\/]node_modules[\\/]/,
            priority: 10,
            chunks: 'initial', // 只打包初始时依赖的第三方
            maxSize: 500000, //
          },
          
       config.optimization.runtimeChunk = {
        name: 'chunk-runtime',
      }
```



